<?php
// Імпорт конфігураційного файлу
require_once '../includes/config.php';
// Підключення налаштувань системи
require_once '../includes/db.php';
// Підключення модуля для роботи з базою даних
require_once '../includes/auth.php';
// Підключення модуля для перевірки авторизації

// Перевірка ролі адміністратора
if (!isAdmin()) {
    // Перевірка, чи користувач є адміністратором
    http_response_code(403);
    // Встановлення коду помилки: доступ заборонено
    echo json_encode(['success' => false, 'message' => 'Недостатньо прав для видалення']);
    // Відповідь: недостатньо прав
    exit;
    // Завершення виконання
}

// Ініціалізація з'єднання з базою даних
$conn = getDbConnection();
// Створення з’єднання з базою даних

// Перевірка наявності та коректності ID звіту
if (!isset($_POST['id']) || !is_numeric($_POST['id'])) {
    // Перевірка, чи передано ID звіту та чи є воно числом
    http_response_code(400);
    // Встановлення коду помилки: невірний запит
    echo json_encode(['success' => false, 'message' => 'Невірний ID звіту']);
    // Відповідь: невірний ID
    exit;
    // Завершення виконання
}

$report_id = (int)$_POST['id'];
// Перетворення ID звіту в ціле число

// Перевірка існування звіту
$sql = "SELECT photo FROM reports WHERE id = $report_id";
$result = $conn->query($sql);
// Запит до бази для пошуку звіту за ID

if ($result->num_rows === 0) {
    // Перевірка, чи знайдено звіт
    http_response_code(404);
    // Встановлення коду помилки: не знайдено
    echo json_encode(['success' => false, 'message' => 'Звіт не знайдено']);
    // Відповідь: звіт не знайдено
    exit;
    // Завершення виконання
}

// Видалення фото, якщо воно існує
$row = $result->fetch_assoc();
// Отримання даних звіту
if ($row['photo']) {
    // Перевірка, чи є фото у звіті
    $photo_path = '../' . $row['photo'];
    // Формування шляху до файлу фото
    if (file_exists($photo_path)) {
        // Перевірка існування файлу
        unlink($photo_path);
        // Видалення файлу фото
    }
}

// Видалення звіту з бази даних
$sql = "DELETE FROM reports WHERE id = $report_id";
if ($conn->query($sql) === TRUE) {
    // Виконання запиту на видалення звіту
    echo json_encode(['success' => true, 'message' => 'Звіт успішно видалено']);
    // Відповідь: звіт видалено
} else {
    http_response_code(500);
    // Встановлення коду помилки: помилка сервера
    echo json_encode(['success' => false, 'message' => 'Помилка при видаленні звіту']);
    // Відповідь: помилка видалення
}

// Завершення з'єднання з базою
$conn->close();
// Закриття з’єднання з базою даних
?>